<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<title>ğŸ· OCC â€” OpenClaw Command Center</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; min-height: 100vh; }
  
  .header { background: #161b22; border-bottom: 1px solid #30363d; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
  .header h1 { font-size: 18px; color: #f0f6fc; }
  .header h1 span { color: #f78166; }
  
  .stats { display: flex; gap: 8px; padding: 12px 20px; flex-wrap: wrap; }
  .stat { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 10px 14px; min-width: 80px; text-align: center; flex: 1; }
  .stat .num { font-size: 24px; font-weight: bold; }
  .stat .label { font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
  .stat.ronald .num { color: #f78166; }
  .stat.pepa .num { color: #bc8cff; }
  .stat.done .num { color: #3fb950; }
  .stat.review .num { color: #d29922; }

  /* Tabs */
  .tabs { display: flex; gap: 0; padding: 0 20px; border-bottom: 1px solid #30363d; background: #161b22; }
  .tab { padding: 10px 16px; font-size: 13px; color: #8b949e; cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; }
  .tab:hover { color: #c9d1d9; }
  .tab.active { color: #f0f6fc; border-bottom-color: #f78166; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Sections */
  .section { padding: 12px 20px; }
  .section-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .section-title .count { font-size: 12px; color: #8b949e; font-weight: 400; }
  
  .cards { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 12px; transition: border-color 0.2s; }
  .card:hover { border-color: #58a6ff; }
  .card.critical { border-left: 3px solid #f85149; }
  .card.high { border-left: 3px solid #d29922; }
  .card-title { font-size: 14px; font-weight: 600; color: #f0f6fc; margin-bottom: 4px; display: flex; align-items: baseline; gap: 6px; }
  .task-id { font-size: 11px; color: #58a6ff; cursor: pointer; font-weight: 700; font-family: monospace; padding: 1px 4px; border-radius: 3px; background: rgba(88,166,255,0.1); user-select: all; white-space: nowrap; }
  .task-id:hover { background: rgba(88,166,255,0.25); }
  .card-desc { font-size: 12px; color: #8b949e; margin-bottom: 8px; line-height: 1.4; }
  .card-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  
  .badge { font-size: 10px; padding: 2px 8px; border-radius: 12px; font-weight: 600; }
  .badge-security { background: #3d1f1f; color: #f85149; }
  .badge-content { background: #2a1a2e; color: #bc8cff; }
  .badge-dev { background: #1a2332; color: #79c0ff; }
  .badge-ops { background: #1f3d2a; color: #3fb950; }
  .badge-research { background: #2a1f0f; color: #d29922; }
  .badge-other { background: #1c1c1c; color: #8b949e; }
  .badge-high { background: #3d1f1f; color: #f85149; }
  .badge-doing { background: #2a1f0f; color: #d29922; }
  .badge-todo { background: #1a2332; color: #79c0ff; }
  .badge-done { background: #1f3d2a; color: #3fb950; }
  .badge-review { background: #3d2a0f; color: #f78166; }
  .badge-reviewed { background: #1f3d2a; color: #3fb950; }
  .badge-routine { background: #2a2a0f; color: #d29922; }
  
  .card-links { display: flex; gap: 8px; margin-top: 8px; }
  .card-link { font-size: 11px; padding: 4px 10px; border-radius: 4px; text-decoration: none; font-weight: 600; }
  .link-drive { background: #1a2332; color: #79c0ff; border: 1px solid #30363d; }
  .link-github { background: #1f2a1a; color: #3fb950; border: 1px solid #30363d; }
  .link-drive:hover, .link-github:hover { opacity: 0.8; }
  
  .card-actions { display: flex; gap: 4px; margin-top: 8px; }
  .card-actions button { font-size: 11px; padding: 3px 10px; border-radius: 4px; border: 1px solid #30363d; background: #21262d; color: #c9d1d9; cursor: pointer; }
  .card-actions button:hover { background: #30363d; }
  .card-actions button.review-btn { border-color: #f78166; color: #f78166; }

  .comments { margin-top: 8px; border-top: 1px solid #21262d; padding-top: 6px; }
  .comment { padding: 4px 0; font-size: 11px; border-bottom: 1px solid #161b22; }
  .comment-author { color: #58a6ff; font-weight: 600; }
  .comment-time { color: #484f58; font-size: 10px; margin-left: 6px; }
  .comment-text { color: #c9d1d9; margin-top: 2px; }
  .comment-form { display: flex; gap: 4px; margin-top: 6px; }
  .comment-form input { flex: 1; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
  .comment-form select { background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 4px 6px; border-radius: 4px; font-size: 11px; }
  .comment-form button { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
  .comment-toggle { font-size: 11px; color: #8b949e; cursor: pointer; margin-top: 6px; }
  .comment-toggle:hover { color: #58a6ff; }

  /* Activity log */
  .activity-log { max-height: 250px; overflow-y: auto; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 8px 12px; font-size: 12px; font-family: monospace; margin: 0 20px 12px; }

  /* Search & Filters */
  .search-bar { margin: 0 20px 12px; display: flex; gap: 8px; }
  .search-bar input { flex: 1; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 12px; border-radius: 6px; font-size: 13px; }
  .search-bar button { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  
  .filters-bar { margin: 0 20px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .filters-bar select { background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 6px 10px; border-radius: 6px; font-size: 12px; }
  .filters-bar .filter-label { font-size: 12px; color: #8b949e; font-weight: 600; }
  .filters-bar .clear-filters { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
  .filters-bar .clear-filters:hover { color: #f85149; border-color: #f85149; }
  #search-results { margin: 0 20px 12px; display: none; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 12px; max-height: 250px; overflow-y: auto; font-size: 12px; }

  /* Add form */
  .add-form { margin: 0 20px 12px; }
  .form-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
  .form-row input, .form-row select, .form-row textarea { background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 12px; border-radius: 6px; font-size: 13px; }
  .form-row input[type=text], .form-row textarea { flex: 1; min-width: 200px; }
  .form-row textarea { resize: vertical; min-height: 60px; }
  .btn-add { background: #238636; border: 1px solid #2ea043; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }

  /* Filter buttons */
  .filters { display: flex; gap: 8px; padding: 8px 20px; }
  .filter-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid #30363d; background: #21262d; color: #8b949e; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
  .filter-btn:hover { border-color: #58a6ff; color: #c9d1d9; }
  .filter-btn.active { background: #f78166; border-color: #f78166; color: #fff; }

  /* Closed section */
  .closed-section { margin: 0 20px 12px; }
  .closed-toggle { cursor: pointer; color: #3fb950; font-size: 13px; padding: 8px 12px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; display: flex; align-items: center; gap: 6px; }
  .closed-toggle:hover { border-color: #3fb950; }

  /* Board view */
  .board { display: flex; gap: 16px; padding: 12px 20px; overflow-x: auto; }
  .column { flex: 1; min-width: 260px; max-width: 400px; }
  .column-header { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 8px 12px; border-radius: 6px 6px 0 0; }
  .col-todo .column-header { background: #1a2332; color: #79c0ff; border-bottom: 2px solid #79c0ff; }
  .col-doing .column-header { background: #2a1f0f; color: #d29922; border-bottom: 2px solid #d29922; }
  .col-done .column-header { background: #0f2a1a; color: #3fb950; border-bottom: 2px solid #3fb950; }

  @media (max-width: 768px) {
    .board { flex-direction: column; }
    .column { max-width: 100%; }
    .stats { gap: 6px; }
    .stat { min-width: 70px; padding: 8px 10px; }
    .stat .num { font-size: 20px; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ· <span>OCC</span> â€” OpenClaw Command Center</h1>
  <div style="text-align:right">
    <div id="clock" style="color:#8b949e;font-size:13px"></div>
    <div id="last-pulse" style="color:#484f58;font-size:11px"></div>
  </div>
</div>

<div class="stats" id="stats"></div>

<div class="tabs">
  <button class="tab active" data-tab="board">ğŸ“‹ Board</button>
  <button class="tab" data-tab="log">ğŸ“¡ Activity</button>
  <button class="tab" data-tab="docs">ğŸ“– Docs</button>
  <button class="tab" data-tab="tools">ğŸ§° Tools</button>
  <button class="tab" data-tab="brain">ğŸ§  Brain</button>
  <button class="tab" data-tab="analytics" style="color:#484f58;font-size:12px;">ğŸ“Š Analytics</button>
</div>

<!-- Tab: Board -->
<div class="tab-content active" id="tab-board">
  <div class="filters">
    <button class="filter-btn active" id="filter-all" onclick="setFilter('all')">Todas</button>
    <button class="filter-btn" id="filter-ronald" onclick="setFilter('ronald')">ğŸ‘¤ Ronald</button>
    <button class="filter-btn" id="filter-pepa" onclick="setFilter('pepa')">ğŸ· Pepa</button>
  </div>
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="ğŸ” Buscar en memoria..." onkeyup="if(event.key==='Enter')searchMemory()">
    <button onclick="searchMemory()">Search</button>
  </div>
  <div id="search-results"></div>

  <div class="filters-bar">
    <span class="filter-label">Filtros:</span>
    <select id="filter-priority" onchange="applyAdvancedFilters()">
      <option value="">Todas las prioridades</option>
      <option value="high">ğŸ”´ Alta</option>
      <option value="normal">Normal</option>
      <option value="low">Baja</option>
    </select>
    <select id="filter-type" onchange="applyAdvancedFilters()">
      <option value="">Todos los tipos</option>
      <option value="dev">Development</option>
      <option value="content">Content</option>
      <option value="ops">Operations</option>
      <option value="security">Security</option>
      <option value="research">Research</option>
      <option value="dashboard">Dashboard</option>
      <option value="other">Other</option>
    </select>
    <select id="filter-status" onchange="applyAdvancedFilters()">
      <option value="">Todos los estados</option>
      <option value="todo">ğŸ“‹ Todo</option>
      <option value="doing">âš¡ Doing</option>
      <option value="done">âœ… Done</option>
      <option value="routine">ğŸ”„ Routine</option>
    </select>
    <button class="clear-filters" onclick="clearAdvancedFilters()">Limpiar</button>
  </div>

  <details style="margin: 0 20px 8px;background:#161b22;border:1px solid #30363d;border-radius:8px;padding:4px 12px;">
    <summary style="cursor:pointer;color:#58a6ff;font-size:14px;font-weight:600;padding:8px 0;">â• Nueva tarea</summary>
    <div class="add-form" style="margin-top:8px;">
      <div class="form-row">
        <input type="text" id="f-title" placeholder="TÃ­tulo de la tarea">
        <select id="f-assignee"><option value="pepa">ğŸ· Pepa</option><option value="ronald">ğŸ‘¤ Ronald</option></select>
        <select id="f-priority"><option value="normal">Normal</option><option value="high">ğŸ”´ Alta</option></select>
      </div>
      <div class="form-row">
        <textarea id="f-desc" placeholder="DescripciÃ³n"></textarea>
      </div>
      <div class="form-row">
        <input type="text" id="f-project" placeholder="Proyecto: nombre â€” IP:puerto (opcional)">
      </div>
      <div class="form-row">
        <label for="f-due" style="color:#8b949e;font-size:12px">ğŸ“… Due date</label>
        <input type="date" id="f-due" style="background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:6px 10px">
      </div>
      <div class="form-row">
        <input type="text" id="f-drive" placeholder="Drive link (opcional)">
        <input type="text" id="f-github" placeholder="GitHub link (opcional)">
        <button class="btn-add" onclick="addTask()">Crear</button>
      </div>
    </div>
  </details>

  <div class="board">
    <div class="column col-todo">
      <div class="column-header">ğŸ“‹ To Do</div>
      <div class="cards" id="cards-todo"></div>
    </div>
    <div class="column col-doing">
      <div class="column-header">âš¡ Doing</div>
      <div class="cards" id="cards-doing"></div>
    </div>
    <div class="column col-done">
      <div class="column-header">ğŸ‘€ Review</div>
      <div class="cards" id="cards-review"></div>
    </div>
  </div>
  <div class="routine-section" style="margin:0 20px 12px;">
    <div style="font-size:14px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px;color:#d29922;">ğŸ”„ Rutinas <span id="routine-count" style="font-size:11px;color:#8b949e;font-weight:400;"></span></div>
    <div class="cards" id="cards-routine"></div>
  </div>

  <div class="closed-section">
    <details>
      <summary class="closed-toggle">âœ… Closed <span id="closed-count" style="font-size:11px;color:#8b949e;margin-left:4px;"></span></summary>
      <div class="cards" id="cards-closed" style="padding:8px 0;"></div>
    </details>
  </div>
</div>

<!-- Tab: Analytics -->
<div class="tab-content" id="tab-analytics">
  <div class="section">
    <div class="section-title">ğŸ“Š Task Performance Metrics</div>
    <div class="stats" id="aging-stats" style="margin-bottom: 16px;">
      <!-- Aging stats will be loaded here -->
    </div>
  </div>
  
  <div class="section">
    <div class="section-title">âš ï¸ Tasks Needing Attention</div>
    <div class="cards" id="stale-tasks">
      <!-- Stale tasks will be loaded here -->
    </div>
  </div>
</div>

<!-- Tab: Activity Log -->
<div class="tab-content" id="tab-log">
  <div style="padding: 12px 0;">
    <div class="activity-log" id="activity-log" style="max-height:500px;"></div>
  </div>
</div>

<!-- Tab: Docs -->
<div class="tab-content" id="tab-docs">
  <div class="section" style="max-width:800px;">

    <div style="background:#161b22;border:1px solid #30363d;border-radius:8px;padding:16px;margin-bottom:16px;">
      <h2 style="color:#f78166;font-size:16px;margin-bottom:12px;">ğŸš€ Quickstart</h2>
      <div style="font-size:13px;line-height:1.7;color:#c9d1d9;">
        <p><strong>Â¿QuÃ© es esto?</strong> El Centro de Mando de Pepa ğŸ· â€” tablero Kanban donde Ronald y Pepa coordinan tareas, rutinas y reviews.</p>
        <p style="margin-top:8px;"><strong>Crear ticket:</strong> Click <span style="color:#58a6ff;">"+ Nueva tarea"</span> arriba del board. Llenar tÃ­tulo, asignado, prioridad, descripciÃ³n, due date.</p>
        <p style="margin-top:8px;"><strong>Editar ticket:</strong> Usar los botones de acciÃ³n en cada card (â–¶ Start, âœ… Done, ğŸ‘€ Approve). Click en la prioridad para cambiarla. Click en el assignee badge para reasignar. Click en la fecha para cambiar due date.</p>
        <p style="margin-top:8px;"><strong>Comentarios:</strong> Click "ğŸ’¬ comments" para abrir, escribir feedback y enviar.</p>
        <p style="margin-top:8px;"><strong>Buscar:</strong> Usar la barra de bÃºsqueda para encontrar en archivos de memoria.</p>
      </div>
    </div>

    <div id="reglas-content" style="font-size:13px;line-height:1.7;color:#c9d1d9;">
      <p style="color:#8b949e;">Cargando reglas...</p>
    </div>

  </div>
</div>

<!-- Tab: Brain -->
<div class="tab-content" id="tab-brain">
  <div class="section" style="max-width:900px;">
    <div id="brain-content" style="font-size:13px;line-height:1.7;color:#c9d1d9;"></div>
  </div>
</div>

<!-- Tab: Tools -->
<div class="tab-content" id="tab-tools">
  <div class="section" style="max-width:900px;">
    <div id="tools-content" style="font-size:13px;line-height:1.7;color:#c9d1d9;"></div>
  </div>
</div>

<script>
const API = '/api';

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    
    // Load analytics when analytics tab is clicked
    if (tab.dataset.tab === 'analytics') {
      loadAnalytics();
    }
    if (tab.dataset.tab === 'tools') {
      loadTools();
    }
    if (tab.dataset.tab === 'brain') {
      loadBrain();
    }
  });
});

let toolsLoaded = false;
async function loadTools() {
  if (toolsLoaded) return;
  try {
    const res = await fetch(API + '/tools');
    const { content } = await res.json();
    // Parse markdown tables and sections into HTML
    const el = document.getElementById('tools-content');
    el.innerHTML = renderToolsMd(content);
    toolsLoaded = true;
  } catch(e) { console.error('Failed to load tools', e); }
}

function renderToolsMd(md) {
  // Extract only the inventory section
  const start = md.indexOf('## ğŸ§° APIs & Skills');
  if (start > -1) md = md.substring(start);
  
  let html = '';
  const lines = md.split('\n');
  let inTable = false;
  let tableHtml = '';
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // Headers
    if (line.startsWith('### ')) {
      if (inTable) { html += tableHtml + '</table></div>'; inTable = false; tableHtml = ''; }
      html += `<div style="background:#161b22;border:1px solid #30363d;border-radius:8px;padding:16px;margin-bottom:16px;">`;
      html += `<h3 style="color:#f78166;font-size:15px;margin-bottom:10px;">${line.replace('### ','')}</h3>`;
      continue;
    }
    if (line.startsWith('## ') && i > 0) {
      if (inTable) { html += tableHtml + '</table></div>'; inTable = false; tableHtml = ''; }
      html += `<h2 style="color:#d29922;font-size:16px;margin:20px 0 12px;">${line.replace('## ','')}</h2>`;
      continue;
    }
    
    // Table rows
    if (line.startsWith('|') && line.includes('|')) {
      const cells = line.split('|').filter(c => c.trim()).map(c => c.trim());
      if (line.includes('---')) continue; // separator
      if (!inTable) {
        inTable = true;
        tableHtml = `<table style="width:100%;font-size:12px;border-collapse:collapse;">`;
        tableHtml += '<tr>' + cells.map(c => `<th style="text-align:left;padding:6px 8px;border-bottom:1px solid #30363d;color:#8b949e;">${c}</th>`).join('') + '</tr>';
      } else {
        // Bold rendering
        const rendered = cells.map(c => c.replace(/\*\*(.*?)\*\*/g, '<strong style="color:#f0f6fc;">$1</strong>').replace(/âš ï¸/g,'âš ï¸'));
        tableHtml += '<tr>' + rendered.map(c => `<td style="padding:6px 8px;border-bottom:1px solid #21262d;color:#c9d1d9;">${c}</td>`).join('') + '</tr>';
      }
      continue;
    }
    
    // End of table
    if (inTable && !line.startsWith('|')) {
      html += tableHtml + '</table></div>';
      inTable = false;
      tableHtml = '';
    }
    
    // Italic note lines
    if (line.startsWith('*') && line.endsWith('*') && !line.startsWith('**')) {
      html += `<p style="color:#8b949e;font-size:11px;margin-top:12px;">${line.replace(/\*/g,'')}</p>`;
    }
  }
  if (inTable) html += tableHtml + '</table></div>';
  return html;
}

// Load Reglas de Oro from REGLAS-DE-ORO.md
(async function loadReglas() {
  try {
    const res = await fetch(API + '/reglas');
    const { content } = await res.json();
    const el = document.getElementById('reglas-content');
    el.innerHTML = renderReglasMd(content);
  } catch(e) { console.error('Failed to load reglas', e); }
})();

function renderReglasMd(md) {
  let html = '';
  const sections = md.split(/^---$/m);
  
  for (const section of sections) {
    const lines = section.trim().split('\n');
    let sectionHtml = '';
    let inList = false;
    let inCode = false;
    
    for (const line of lines) {
      if (line.startsWith('```')) { 
        if (!inCode) { sectionHtml += '<div style="background:#0d1117;padding:10px;border-radius:6px;margin:8px 0;font-family:monospace;font-size:12px;">'; inCode = true; }
        else { sectionHtml += '</div>'; inCode = false; }
        continue;
      }
      if (inCode) { sectionHtml += line + '<br>'; continue; }
      if (line.startsWith('# ')) { sectionHtml += `<h2 style="color:#d29922;font-size:16px;margin-bottom:12px;">${line.replace('# ','')}</h2>`; continue; }
      if (line.startsWith('## ')) { sectionHtml += `<h2 style="color:#58a6ff;font-size:16px;margin:16px 0 8px;">${line.replace('## ','')}</h2>`; continue; }
      if (line.startsWith('- ')) {
        if (!inList) { sectionHtml += '<ul style="margin-left:20px;color:#8b949e;">'; inList = true; }
        sectionHtml += `<li>${line.replace('- ','').replace(/\*\*(.*?)\*\*/g,'<strong style="color:#f0f6fc;">$1</strong>')}</li>`;
        continue;
      }
      if (inList && !line.startsWith('- ')) { sectionHtml += '</ul>'; inList = false; }
      if (line.trim() === '') continue;
      const rendered = line.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`(.*?)`/g,'<code style="background:#0d1117;padding:2px 6px;border-radius:3px;font-size:12px;">$1</code>');
      sectionHtml += `<p style="margin:6px 0;">${rendered}</p>`;
    }
    if (inList) sectionHtml += '</ul>';
    if (sectionHtml.trim()) {
      html += `<div style="background:#161b22;border:1px solid #30363d;border-radius:8px;padding:16px;margin-bottom:16px;">${sectionHtml}</div>`;
    }
  }
  return html;
}

let brainLoaded = false;
async function loadBrain() {
  const el = document.getElementById('brain-content');
  if (brainLoaded) return;
  try {
    const res = await fetch(API + '/brain');
    const files = await res.json();
    
    // Order: core files first, then daily notes newest first
    const order = ['IDENTITY.md', 'SOUL.md', 'USER.md', 'AGENTS.md', 'HEARTBEAT.md', 'MEMORY.md'];
    const dailyKeys = Object.keys(files).filter(k => k.startsWith('memory/')).sort().reverse();
    const allKeys = [...order.filter(k => files[k]), ...dailyKeys];
    
    const icons = { 'SOUL.md':'ğŸ‘»', 'IDENTITY.md':'ğŸ·', 'USER.md':'ğŸ‘¤', 'MEMORY.md':'ğŸ§ ', 'AGENTS.md':'ğŸ“‹', 'HEARTBEAT.md':'ğŸ’“' };
    
    let html = '';
    for (const key of allKeys) {
      const icon = icons[key] || 'ğŸ“';
      const label = key.startsWith('memory/') ? 'ğŸ“ ' + key.replace('memory/','') : icon + ' ' + key;
      const id = 'brain-' + key.replace(/[^a-zA-Z0-9]/g, '-');
      const expanded = (key === 'IDENTITY.md' || key === 'HEARTBEAT.md') ? 'open' : '';
      
      html += `<details ${expanded} style="background:#161b22;border:1px solid #30363d;border-radius:8px;margin-bottom:8px;">`;
      html += `<summary style="padding:12px 16px;cursor:pointer;color:#f0f6fc;font-weight:600;font-size:14px;user-select:none;">${label}</summary>`;
      html += `<div style="padding:4px 16px 16px;border-top:1px solid #30363d;"><pre style="white-space:pre-wrap;word-break:break-word;font-size:12px;color:#c9d1d9;font-family:ui-monospace,monospace;line-height:1.6;margin:0;">${escapeHtml(files[key])}</pre></div>`;
      html += `</details>`;
    }
    
    el.innerHTML = html;
    brainLoaded = true;
  } catch(e) { el.innerHTML = '<p style="color:#f85149;">Error loading brain files</p>'; console.error(e); }
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function formatDate(d) {
  if (!d) return '';
  const dt = new Date(d.includes('Z') || d.includes('+') || d.includes('-',10) ? d : d + 'Z');
  return dt.toLocaleDateString('es-PA', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function catBadge(cat) {
  const map = { security: 'badge-security', content: 'badge-content', dev: 'badge-dev', ops: 'badge-ops', research: 'badge-research' };
  const labels = { security: 'ğŸ”’ Security', content: 'ğŸ“ Content', dev: 'ğŸ’» Dev', ops: 'âš™ï¸ Ops', research: 'ğŸ” Research',
    blog: 'ğŸ“ Blog', code: 'ğŸ’» Code', draft: 'âœï¸ Draft', dashboard: 'ğŸ“Š Dashboard', other: 'ğŸ“Œ Other' };
  const cls = map[cat] || 'badge-other';
  const label = labels[cat] || cat;
  return `<span class="badge ${cls}">${label}</span>`;
}

function renderCard(task, showActions) {
  const prioClass = task.priority === 'high' ? 'high' : (task.priority === 'critical' ? 'critical' : '');
  const prioMap = {
    low: {label:'LOW', bg:'#1c1c1c', color:'#484f58'},
    normal: {label:'NORMAL', bg:'#1a2332', color:'#58a6ff'},
    high: {label:'HIGH', bg:'#3d1f1f', color:'#f85149'},
    critical: {label:'CRITICAL', bg:'#5c1a1a', color:'#ff6b6b'}
  };
  const prio = prioMap[task.priority] || prioMap.normal;
  const prioLabel = `<span class="badge" style="background:${prio.bg};color:${prio.color};cursor:pointer;" onclick="cyclePriority(${task.id},'${task.priority}')" title="Tap to change priority">${prio.label}</span>`;
  const statusBadge = `<span class="badge badge-${task.status}">${task.status.toUpperCase()}</span>`;
  const assigneeIcon = task.assignee === 'ronald' ? 'ğŸ‘¤' : 'ğŸ·';

  let reviewBadge = '';
  if (task.status === 'done') {
    reviewBadge = task.reviewed_by_ronald 
      ? '<span class="badge badge-reviewed">âœ… Reviewed</span>' 
      : '<span class="badge badge-review">â³ Pending Review</span>';
  }

  let links = '';
  if (task.drive_link || task.github_link || task.deliverable_url) {
    links = '<div class="card-links">';
    if (task.drive_link) links += `<a class="card-link link-drive" href="${task.drive_link}" target="_blank">ğŸ“„ Drive</a>`;
    if (task.github_link) links += `<a class="card-link link-github" href="${task.github_link}" target="_blank">ğŸ”— GitHub</a>`;
    if (task.deliverable_url) links += `<a class="card-link link-drive" href="${task.deliverable_url}" target="_blank">ğŸ“ Link</a>`;
    links += '</div>';
  }

  let actions = '';
  if (showActions) {
    const cancelBtn = `<button style="border-color:#f85149;color:#f85149;" onclick="if(confirm('Â¿Cancelar #${task.id}?'))updateTask(${task.id},{status:'archived'})">âœ•</button>`;
    if (task.status === 'todo') actions = `<button onclick="updateTask(${task.id},{status:'doing'})">â–¶ Start</button> ${cancelBtn}`;
    else if (task.status === 'doing') actions = `<button onclick="updateTask(${task.id},{status:'todo'})">â—€ To Do</button><button onclick="updateTask(${task.id},{status:'done'})">âœ… Done</button> ${cancelBtn}`;
    else if (task.status === 'done' && !task.reviewed_by_ronald) {
      if (task.assignee === 'ronald') {
        actions = `<button onclick="updateTask(${task.id},{status:'doing'})">â—€ Doing</button><button class="review-btn" style="border-color:#bc8cff;color:#bc8cff;" onclick="updateTask(${task.id},{assignee:'pepa'})">ğŸ· Pepa Review</button> ${cancelBtn}`;
      } else {
        actions = `<button onclick="updateTask(${task.id},{status:'doing'})">â—€ Doing</button><button class="review-btn" onclick="updateTask(${task.id},{reviewed_by_ronald:1})">ğŸ‘€ Approve</button> ${cancelBtn}`;
      }
    }
  }

  const comments = task.comments || [];
  const commentsHtml = comments.map(c => 
    `<div class="comment"><span class="comment-author">${c.author}</span><span class="comment-time">${formatDate(c.timestamp)}</span><div class="comment-text">${c.text}</div></div>`
  ).join('');

  const assigneeLabel = task.assignee === 'ronald' ? 'ğŸ‘¤ Ronald' : 'ğŸ· Pepa';
  const toggleAssignee = task.assignee === 'ronald' ? 'pepa' : 'ronald';
  const assigneeBadge = `<span class="badge" style="background:${task.assignee==='ronald'?'#3d2a0f':'#2a1a2e'};color:${task.assignee==='ronald'?'#f78166':'#bc8cff'};cursor:pointer" onclick="updateTask(${task.id},{assignee:'${toggleAssignee}'})" title="Click para cambiar a ${toggleAssignee}">${assigneeLabel}</span>`;

  const taskId = `#${task.id}`;
  const projectRef = task.project_ref || '';

  return `<div class="card ${prioClass}" data-assignee="${task.assignee}">
    <div class="card-title"><span class="task-id" onclick="copyId('${taskId}',this)" title="Tap to copy ${taskId}">${taskId}</span> ${task.title}</div>
    ${task.parent_id ? `<div style="font-size:11px;margin-bottom:4px;padding:3px 8px;background:rgba(88,166,255,0.1);border-left:2px solid #58a6ff;border-radius:0 4px 4px 0;">â†³ subtarea de <span class="task-id" onclick="copyId('#${task.parent_id}',this)" style="font-size:10px">#${task.parent_id}</span></div>` : ''}
    ${projectRef ? `<div style="font-size:11px;color:#58a6ff;margin-bottom:4px;">ğŸ“‚ ${projectRef}</div>` : ''}
    ${task.description ? `<div class="card-desc">${task.description}</div>` : ''}
    <div class="card-meta">${assigneeBadge} ${catBadge(task.deliverable_type || task.category || 'other')} ${prioLabel} ${reviewBadge} ${(() => {
      if (!task.due_date) return '';
      const due = new Date(task.due_date + 'T23:59:59');
      const now = new Date();
      const days = Math.ceil((due - now) / 86400000);
      const color = days < 0 ? '#f85149' : days <= 2 ? '#d29922' : '#58a6ff';
      const label = days < 0 ? 'âš ï¸ VENCIDA' : days === 0 ? 'ğŸ“… HOY' : days <= 2 ? 'ğŸ“… ' + days + 'd' : 'ğŸ“… ' + task.due_date;
      return '<span class="badge" style="background:' + (days < 0 ? '#3d1214' : days <= 2 ? '#3d2a0f' : '#0d1d30') + ';color:' + color + ';cursor:pointer" onclick="promptDueDate(' + task.id + ')" title="Click para cambiar due date">' + label + '</span>';
    })()}</div>
    ${links}
    ${actions ? `<div class="card-actions">${actions}</div>` : ''}
    <div class="comment-toggle" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
      ğŸ’¬ ${comments.length} comment${comments.length!==1?'s':''} ${comments.length?'':'â€” add one'}
    </div>
    <div class="comments" style="display:none">
      ${commentsHtml}
      <div class="comment-form">
        <select id="author-${task.id}"><option value="Ronald">Ronald</option><option value="Pepa">Pepa</option></select>
        <input type="text" id="comment-${task.id}" placeholder="Write feedback..." onkeyup="if(event.key==='Enter')addComment(${task.id})">
        <button onclick="addComment(${task.id})">Send</button>
      </div>
    </div>
  </div>`;
}

function logIcon(type) {
  const map = { task_created: 'ğŸ“‹', task_updated: 'âœï¸', cron_checkin: 'ğŸ¤–', comment_added: 'ğŸ’¬' };
  return map[type] || 'ğŸ“Œ';
}

function promptDueDate(id) {
  const val = prompt('Due date (YYYY-MM-DD) o vacÃ­o para quitar:');
  if (val === null) return;
  updateTask(id, { due_date: val || null });
}

function copyId(text, el) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text);
  } else {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
  el.style.color = '#3fb950';
  el.textContent = 'âœ“ copied';
  setTimeout(() => { el.style.color = ''; el.textContent = text; }, 1000);
}

function cyclePriority(id, current) {
  const cycle = ['low','normal','high','critical'];
  const next = cycle[(cycle.indexOf(current) + 1) % cycle.length];
  updateTask(id, {priority: next});
}

let currentFilter = 'all';

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('filter-' + f).classList.add('active');
  if (window._allTasks) renderBoard(window._allTasks);
}

function renderBoard(tasks) {
  const f = currentFilter;
  const filtered = f === 'all' ? tasks : tasks.filter(t => t.assignee === f);
  
  const routineTasks = filtered.filter(t => t.status === 'routine');
  const nonRoutine = filtered.filter(t => t.status !== 'routine');
  
  // "done" tasks split: unreviewed â†’ Review column, reviewed â†’ Closed
  const reviewTasks = nonRoutine.filter(t => t.status === 'done' && !t.reviewed_by_ronald);
  const closedTasks = nonRoutine.filter(t => t.status === 'done' && t.reviewed_by_ronald);
  
  const empty = '<div style="color:#484f58;padding:12px;font-size:12px">â€”</div>';
  document.getElementById('cards-todo').innerHTML = nonRoutine.filter(t=>t.status==='todo').map(t=>renderCard(t,true)).join('') || empty;
  document.getElementById('cards-doing').innerHTML = nonRoutine.filter(t=>t.status==='doing').map(t=>renderCard(t,true)).join('') || empty;
  document.getElementById('cards-review').innerHTML = reviewTasks.map(t=>renderCard(t,true)).join('') || empty;
  document.getElementById('cards-routine').innerHTML = routineTasks.map(t=>renderCard(t,false)).join('') || empty;
  document.getElementById('routine-count').textContent = `(${routineTasks.length})`;
  document.getElementById('cards-closed').innerHTML = closedTasks.map(t=>renderCard(t,false)).join('') || '<div style="color:#484f58;padding:12px;font-size:12px">Nada cerrado aÃºn</div>';
  document.getElementById('closed-count').textContent = `(${closedTasks.length})`;
}

// Track which comment sections are open
window._openComments = new Set();

function isUserTypingComment() {
  const active = document.activeElement;
  return active && active.id && active.id.startsWith('comment-');
}

async function loadAnalytics() {
  try {
    const aging = await fetch(API+'/aging').then(r=>r.json());
    const stats = aging.metrics;
    
    // Display aging stats
    document.getElementById('aging-stats').innerHTML = `
      <div class="stat"><div class="num" style="color:#f85149">${stats.stale_tasks}</div><div class="label">Stale Tasks</div></div>
      <div class="stat"><div class="num" style="color:#d29922">${stats.ancient_tasks}</div><div class="label">Ancient Tasks</div></div>
      <div class="stat"><div class="num" style="color:#3fb950">${stats.avg_completion_hours}h</div><div class="label">Avg Completion</div></div>
      <div class="stat"><div class="num" style="color:#bc8cff">${Math.floor(stats.oldest_active/24)}d</div><div class="label">Oldest Active</div></div>
    `;
    
    // Display stale tasks
    const staleTasksHtml = aging.tasks
      .filter(t => (t.isStale || t.isAncient) && t.status !== 'done')
      .map(task => `
        <div class="card ${task.priority === 'high' ? 'high' : task.isAncient ? 'critical' : ''}">
          <div class="card-title">
            <span class="task-id" onclick="copyText('#${task.id}')">#${task.id}</span>
            ${task.title}
          </div>
          <div class="card-desc">
            ${task.project_ref ? `<strong>${task.project_ref}</strong><br>` : ''}
            Age: ${Math.floor(task.ageHours/24)}d ${task.ageHours%24}h
            ${task.staleDays > 0 ? `| Stale: ${task.staleDays}d` : ''}
          </div>
          <div class="card-meta">
            <span class="badge badge-${task.status}">${task.status}</span>
            <span class="badge badge-${task.priority}">${task.priority}</span>
            <span class="badge ${task.assignee === 'ronald' ? 'badge-other' : 'badge-content'}">${task.assignee}</span>
            ${task.isAncient ? '<span class="badge badge-security">ANCIENT</span>' : ''}
            ${task.isStale ? '<span class="badge badge-high">STALE</span>' : ''}
          </div>
        </div>
      `).join('');
    
    document.getElementById('stale-tasks').innerHTML = staleTasksHtml || 
      '<div style="color:#3fb950;padding:12px;font-size:12px">âœ… No stale tasks - everything looks healthy!</div>';
      
  } catch (error) {
    console.error('Failed to load analytics:', error);
    document.getElementById('aging-stats').innerHTML = '<div style="color:#f85149;padding:12px;">Failed to load analytics</div>';
  }
}

async function load() {
  // Skip refresh if user is actively typing a comment (fixes premature close bug)
  if (isUserTypingComment()) return;

  // Remember which comment sections are open before re-render
  document.querySelectorAll('.comments').forEach(el => {
    if (el.style.display !== 'none') {
      const input = el.querySelector('input[id^="comment-"]');
      if (input) window._openComments.add(input.id.replace('comment-',''));
    }
  });

  const [tasks, stats, activity] = await Promise.all([
    fetch(API+'/tasks').then(r=>r.json()),
    fetch(API+'/stats').then(r=>r.json()),
    fetch(API+'/activity?limit=50').then(r=>r.json())
  ]);
  
  // Also load analytics if that tab is active or will be loaded later
  if (document.querySelector('.tab[data-tab="analytics"]')) {
    loadAnalytics();
  }

  // Stats
  document.getElementById('stats').innerHTML = `
    <div class="stat ronald"><div class="num">${stats.ronald_pending||0}</div><div class="label">ğŸ‘¤ Ronald</div></div>
    <div class="stat pepa"><div class="num">${stats.pepa_active||0}</div><div class="label">ğŸ· Pepa</div></div>
    <div class="stat done"><div class="num">${stats.done}</div><div class="label">Done</div></div>
    <div class="stat review"><div class="num">${stats.pending_review}</div><div class="label">â³ Review</div></div>
  `;

  // Store tasks globally for filtering
  window._allTasks = tasks;
  renderBoard(tasks);

  // Restore open comment sections after re-render
  window._openComments.forEach(taskId => {
    const commentsDiv = document.getElementById('comment-' + taskId);
    if (commentsDiv) {
      const section = commentsDiv.closest('.comments');
      if (section) section.style.display = 'block';
    }
  });

  // Activity log
  document.getElementById('activity-log').innerHTML = activity.length
    ? activity.map(a => {
        const t = new Date(a.timestamp).toLocaleString('es-PA', {timeZone:'America/Panama', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
        return `<div style="padding:3px 0;border-bottom:1px solid #21262d;color:#8b949e;">${logIcon(a.type)} <span style="color:#484f58">${t}</span> ${a.message}</div>`;
      }).join('')
    : '<div style="color:#484f58">No activity yet ğŸ’¤</div>';
}

async function addTask() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) return;
  await fetch(API+'/tasks', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      title,
      description: document.getElementById('f-desc').value.trim(),
      assignee: document.getElementById('f-assignee').value,
      priority: document.getElementById('f-priority').value,
      drive_link: document.getElementById('f-drive').value.trim() || null,
      github_link: document.getElementById('f-github').value.trim() || null,
      project_ref: document.getElementById('f-project').value.trim() || null,
      due_date: document.getElementById('f-due').value || null,
    })
  });
  document.getElementById('f-title').value = '';
  document.getElementById('f-desc').value = '';
  document.getElementById('f-drive').value = '';
  document.getElementById('f-github').value = '';
  load();
}

async function updateTask(id, fields) {
  const scrollY = window.scrollY;
  await fetch(API+'/tasks/'+id, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(fields) });
  await load();
  window.scrollTo(0, scrollY);
}

async function addComment(taskId) {
  const input = document.getElementById('comment-' + taskId);
  const author = document.getElementById('author-' + taskId);
  const text = input.value.trim();
  if (!text) return;
  const scrollY = window.scrollY;
  await fetch(API+'/tasks/'+taskId+'/comments', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({author:author.value, text}) });
  input.value = '';
  await load();
  window.scrollTo(0, scrollY);
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleString('es-PA', { timeZone:'America/Panama', weekday:'short', hour:'2-digit', minute:'2-digit' });
}

async function searchMemory() {
  const q = document.getElementById('search-input').value.trim();
  const div = document.getElementById('search-results');
  if (!q) { div.style.display = 'none'; return; }
  const results = await fetch(API+'/search?q='+encodeURIComponent(q)).then(r=>r.json());
  div.style.display = 'block';
  div.innerHTML = results.length 
    ? results.map(r => `<div style="padding:4px 0;border-bottom:1px solid #21262d;"><span style="color:#58a6ff;font-size:11px;">${r.file}:${r.line}</span><div style="color:#c9d1d9;margin-top:2px;">${r.text}</div></div>`).join('')
    : '<span style="color:#484f58">No results</span>';
}

async function updatePulse() {
  const activity = await fetch(API+'/activity?limit=1').then(r=>r.json());
  if (activity.length) {
    const a = activity[0];
    const diff = Date.now() - new Date(a.timestamp).getTime();
    const mins = Math.floor(diff/60000);
    const ago = mins < 1 ? 'just now' : mins < 60 ? mins+'m ago' : Math.floor(mins/60)+'h ago';
    document.getElementById('last-pulse').textContent = 'ğŸ«€ ' + ago + ' â€” ' + a.message.slice(0,50);
  }
}

// Advanced Filters
function applyAdvancedFilters() {
  const priority = document.getElementById('filter-priority').value;
  const type = document.getElementById('filter-type').value;
  const status = document.getElementById('filter-status').value;
  
  if (!window._allTasks) return;
  
  let filtered = window._allTasks.filter(task => {
    if (priority && task.priority !== priority) return false;
    if (type && task.deliverable_type !== type) return false;
    if (status && task.status !== status) return false;
    return true;
  });
  
  renderBoard(filtered);
}

function clearAdvancedFilters() {
  document.getElementById('filter-priority').value = '';
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-status').value = '';
  
  if (window._allTasks) {
    renderBoard(window._allTasks);
  }
}

load();
setInterval(load, 30000);
updateClock();
setInterval(updateClock, 60000);
updatePulse();
setInterval(updatePulse, 60000);
</script>
</body>
</html>
